@page "/vocabulary/match/{WeekId}"
@using french_app.Models
@using french_app.Services
@using Microsoft.JSInterop
@inject VocabularyService Vocab
@inject IJSRuntime JS

<PageTitle>Match Game</PageTitle>

<div class="vocab-page">
    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <div>
            <h1 class="m-0">Match</h1>
            <div class="text-muted">@TitleSuffix</div>
        </div>
        <div class="text-end">
            <div class="fw-semibold">Points: @_points</div>
            <div class="text-muted small">Streak: @_streak</div>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/vocabulary/match">Change</a>
            <button class="btn btn-outline-primary" @onclick="ResetGame" disabled="@(_terms.Count == 0)">Reset</button>
        </div>
    </div>

    @if (_loading)
    {
        <div class="alert alert-info mt-3">Loading terms…</div>
    }
    else if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger mt-3">@_error</div>
    }
    else if (_terms.Count == 0)
    {
        <div class="alert alert-warning mt-3">No terms to match.</div>
    }
    else
    {
        @($"Group {_pageIndex + 1} / {_totalPages}")

        <div class="row g-3 mt-3">
            <div class="col-6">
                <h5>French</h5>
                @foreach (var pair in _currentFrench)
                {
                    <div class="card match-card @(pair.FrenchText == _selectedFrench ? "selected" : "")"
                         @onclick="() => SelectFrench(pair.FrenchText)">
                        @pair.FrenchText
                    </div>
                }
            </div>
            <div class="col-6">
                <h5>English</h5>
                @foreach (var eng in _currentEnglish)
                {
                    <div class="card match-card @(eng == _selectedEnglish ? "selected" : "")"
                         @onclick="() => SelectEnglish(eng)">
                        @eng
                    </div>
                }
            </div>
        </div>
        <div class="d-flex gap-2 mt-4">
            <button class="btn btn-outline-primary flex-fill" @onclick="PrevPage" disabled="@(_pageIndex == 0)">Prev</button>
            <button class="btn btn-outline-primary flex-fill" @onclick="NextPage" disabled="@(_pageIndex >= _totalPages - 1)">Next</button>
        </div>
    }
</div>
<!-- Bootstrap Toast -->
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3">
    <div id="matchToast" class="toast text-white" role="alert" data-bs-delay="1800">
        <div class="toast-body text-center" id="matchToastBody"></div>
    </div>
</div>

<style>
    .match-card {
        padding: 14px;
        margin-bottom: 10px;
        cursor: pointer;
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        transition: .15s;
    }

        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,.08);
        }

    .selected {
        background: #e3f2fd;
        border-color: #0d6efd;
    }
</style>
@code {
    [Parameter] public string WeekId { get; set; } = "all";

    private bool _loading = true;
    private string? _error;
    private readonly List<VocabularyTerm> _terms = new();
    private int _pageIndex = 0;
    private int _pageSize = 10;
    private int _totalPages = 1;
    private List<VocabularyTerm> _currentFrench = new();
    private List<string> _currentEnglish = new();
    private HashSet<string> _matchedFrench = new(StringComparer.Ordinal);
    private string? _selectedFrench;
    private string? _selectedEnglish;
    private Random _rng = new();
    private int _points = 0;
    private int _streak = 0;
    private int _groupMaxScore = 0;
    private int _groupScore = 0;

    private string TitleSuffix => WeekId.Equals("all", StringComparison.OrdinalIgnoreCase)
        ? "All weeks"
        : DisplayWeek(WeekId);

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;
        _terms.Clear();
        _pageIndex = 0;
        _matchedFrench.Clear();
        _selectedFrench = null;
        _selectedEnglish = null;
        _points = 0;
        _streak = 0;
        _groupMaxScore = 0;
        _groupScore = 0;
        try
        {
            if (WeekId.Equals("all", StringComparison.OrdinalIgnoreCase))
            {
                var weeks = await Vocab.GetAvailableWeeksAsync();
                foreach (var w in weeks)
                {
                    var pack = await Vocab.LoadWeekAsync(w);
                    if (pack is not null)
                    {
                        _terms.AddRange(pack.Terms);
                    }
                }
            }
            else
            {
                var pack = await Vocab.LoadWeekAsync(WeekId);
                if (pack is not null)
                {
                    _terms.AddRange(pack.Terms);
                }
            }
            ShuffleTerms();
            RecalcPages();
            UpdatePage();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void ShuffleTerms()
    {
        var n = _terms.Count;
        for (var i = n - 1; i > 0; i--)
        {
            var j = _rng.Next(i + 1);
            (_terms[i], _terms[j]) = (_terms[j], _terms[i]);
        }
    }

    private void RecalcPages()
    {
        _totalPages = Math.Max(1, (_terms.Count + _pageSize - 1) / _pageSize);
        if (_pageIndex >= _totalPages) _pageIndex = _totalPages - 1;
    }

    private void UpdatePage()
    {
        // Each page is a fixed batch of up to 10 pairs.
        // Correct matches are tracked and removed from display without pulling in a replacement.
        _matchedFrench.Clear();
        _groupScore = 0;
        var page = _terms
            .Skip(_pageIndex * _pageSize)
            .Take(_pageSize)
            .ToList();

        // Max score for a group assumes a perfect run (all correct, no penalties).
        // With current scoring: base 10 + streak bonus (0,2,4...) capped at 20.
        // For up to 10 items, cap doesn't apply (max streak bonus hits 18).
        _groupMaxScore = 0;
        for (var i = 1; i <= page.Count; i++)
        {
            _groupMaxScore += 10 + Math.Min(20, (i - 1) * 2);
        }

        _currentFrench = page;
        _currentEnglish = page
            .Select(x => x.EnglishText)
            .OrderBy(_ => _rng.Next())
            .ToList();
    }

    private async Task SelectFrench(string f)
    {
        _selectedFrench = f;
        await SpeakCurrentFrench(_selectedFrench);
        await TryMatch();
    }

    private async Task SelectEnglish(string e)
    {
        _selectedEnglish = e;
        await TryMatch();
    }

    private async Task TryMatch()
    {
        if (_selectedFrench == null || _selectedEnglish == null) return;

        var pair = _currentFrench.FirstOrDefault(p => p.FrenchText == _selectedFrench);
        bool correct = pair is not null && pair.EnglishText == _selectedEnglish;
        await JS.InvokeVoidAsync("showMatchToast", correct ? "Correct!" : "Incorrect — try again", correct);

        if (correct && pair is not null)
        {
            _streak++;
            var earned = 10 + Math.Min(20, (_streak - 1) * 2);
            _points += earned;
            _groupScore += earned;

            // Do not add a replacement term mid-batch; just mark as matched and remove from display.
            _matchedFrench.Add(pair.FrenchText);
            _currentFrench.Remove(pair);
            _currentEnglish.Remove(_selectedEnglish);
        }
        else
        {
            _streak = 0;
            _points = Math.Max(0, _points - 2);
            _groupScore = Math.Max(0, _groupScore - 2);
        }

        var perfectGroup = _currentFrench.Count == 0 && _groupScore >= _groupMaxScore && _groupMaxScore > 0;
        if (perfectGroup)
        {
            await JS.InvokeVoidAsync("showConfettiBurst");
        }
        _selectedFrench = null;
        _selectedEnglish = null;
    }

    private void ResetGame()
    {
        _pageIndex = 0;
        _matchedFrench.Clear();
        _selectedFrench = null;
        _selectedEnglish = null;
        _points = 0;
        _streak = 0;
        _groupMaxScore = 0;
        _groupScore = 0;
        ShuffleTerms();
        RecalcPages();
        UpdatePage();
    }

    private void NextPage()
    {
        if (_pageIndex < _totalPages - 1)
        {

            _pageIndex++;
            _selectedFrench = null;
            _selectedEnglish = null;
            UpdatePage();
        }
    }


    private void PrevPage()
    {
        if (_pageIndex > 0)
        {
            _pageIndex--;
            _selectedFrench = null;
            _selectedEnglish = null;
            UpdatePage();
        }
    }

    private async Task SpeakCurrentFrench(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return;

        await JS.InvokeVoidAsync("speakText", text, "fr-FR");
    }
    private static string DisplayWeek(string weekId)
        => string.IsNullOrWhiteSpace(weekId) ? "Week" : weekId.Replace('-', ' ').Replace('_', ' ');
}
