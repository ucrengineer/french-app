@page "/vocabulary/study/{WeekId}"
@using french_app.Models
@using french_app.Services
@inject VocabularyService Vocab

<PageTitle>Study @TitleSuffix</PageTitle>

<div class="vocab-page">
    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <div>
            <h1 class="m-0">Flashcards</h1>
            <div class="text-muted">@TitleSuffix</div>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/vocabulary/study">Change</a>
            <button class="btn btn-outline-primary" @onclick="Shuffle" disabled="@(_terms.Count == 0)">Shuffle</button>
        </div>
    </div>

    @if (_loading)
    {
        <div class="alert alert-info mt-3">Loading termsâ€¦</div>
    }
    else if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="alert alert-danger mt-3">@_error</div>
    }
    else if (_terms.Count == 0)
    {
        <div class="alert alert-warning mt-3">No terms to study.</div>
    }
    else
    {
        <div class="study-controls mt-3">
            <div class="btn-group w-100" role="group">
                <button class="btn btn-outline-secondary" @onclick="Prev">Prev</button>
                <button class="btn btn-primary" @onclick="Flip">@(_showAnswer ? "Hide" : "Show")</button>
                <button class="btn btn-outline-secondary" @onclick="Next">Next</button>
            </div>
            <div class="d-flex justify-content-between text-muted small mt-2">
                <div>@(_index + 1) / @_terms.Count</div>
                <button class="btn btn-link p-0" @onclick="Reset">Restart</button>
            </div>
        </div>

        <div class="study-card mt-3" @onclick="Flip">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="study-prompt text-muted small">Tap card to flip</div>
                    <div class="study-front" hidden="@_showAnswer">
                        <div class="study-lang">FR</div>
                        <div class="study-text">@Current.FrenchText</div>
                    </div>
                    <div class="study-back" hidden="@(!_showAnswer)">
                        <div class="study-lang">EN</div>
                        <div class="study-text">@Current.EnglishText</div>
                        @if (!string.IsNullOrWhiteSpace(Current.Example))
                        {
                            <div class="small mt-3">@Current.Example</div>
                        }
                        @if (!string.IsNullOrWhiteSpace(Current.Notes))
                        {
                            <div class="small text-muted mt-2">@Current.Notes</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string WeekId { get; set; } = "all";

    private bool _loading = true;
    private string? _error;

    private readonly List<VocabularyTerm> _terms = new();
    private int _index;
    private bool _showAnswer;

    private VocabularyTerm Current => _terms.Count == 0 ? new VocabularyTerm() : _terms[_index];

    private string TitleSuffix => WeekId.Equals("all", StringComparison.OrdinalIgnoreCase)
        ? "All weeks"
        : DisplayWeek(WeekId);

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;
        _terms.Clear();
        _index = 0;
        _showAnswer = false;

        try
        {
            if (WeekId.Equals("all", StringComparison.OrdinalIgnoreCase))
            {
                var weeks = await Vocab.GetAvailableWeeksAsync();
                foreach (var w in weeks)
                {
                    var pack = await Vocab.LoadWeekAsync(w);
                    if (pack is not null)
                    {
                        _terms.AddRange(pack.Terms);
                    }
                }
            }
            else
            {
                var pack = await Vocab.LoadWeekAsync(WeekId);
                if (pack is not null)
                {
                    _terms.AddRange(pack.Terms);
                }
            }

            Shuffle();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void Flip() => _showAnswer = !_showAnswer;

    private void Next()
    {
        if (_terms.Count == 0) return;
        _index = (_index + 1) % _terms.Count;
        _showAnswer = false;
    }

    private void Prev()
    {
        if (_terms.Count == 0) return;
        _index = (_index - 1 + _terms.Count) % _terms.Count;
        _showAnswer = false;
    }

    private void Reset()
    {
        _index = 0;
        _showAnswer = false;
    }

    private void Shuffle()
    {
        if (_terms.Count <= 1)
        {
            _index = 0;
            _showAnswer = false;
            return;
        }

        var rng = Random.Shared;
        for (var i = _terms.Count - 1; i > 0; i--)
        {
            var j = rng.Next(i + 1);
            (_terms[i], _terms[j]) = (_terms[j], _terms[i]);
        }

        _index = 0;
        _showAnswer = false;
    }

    private static string DisplayWeek(string weekId)
        => string.IsNullOrWhiteSpace(weekId) ? "Week" : weekId.Replace('-', ' ').Replace('_', ' ');
}
